name: Keep Streamlit App Alive

on:
  schedule:
    - cron: '*/10 * * * *'
  workflow_dispatch:

jobs:
  wake-up:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Selenium & Chrome
        run: |
          python -m pip install selenium
          sudo apt-get update
          sudo apt-get install -y chromium-browser chromium-chromedriver

      - name: Run Selenium script
        run: |
          python - <<EOF
          from selenium import webdriver
          from selenium.webdriver.common.by import By
          from selenium.webdriver.support.ui import WebDriverWait
          from selenium.webdriver.support import expected_conditions as EC

          options = webdriver.ChromeOptions()
          options.add_argument("--headless")
          options.add_argument("--no-sandbox")
          
          driver = webdriver.Chrome(options=options)
          
          try:
              driver.get("https://makans.streamlit.app/")
              
              # Wait max 30 seconds for elements
              wait = WebDriverWait(driver, 30)
              
              # Check for sleep page
              try:
                  button = wait.until(EC.presence_of_element_located(
                      (By.XPATH, '//button[contains(., "Yes, get this app back up!")]')
                  ))
                  print("App asleep - clicking button...")
                  button.click()
                  
                  # Wait for app container to reload
                  wait.until(EC.presence_of_element_located(
                      (By.CLASS_NAME, "stApp")
                  ))
                  print("App restarted!")
                  
              except:
                  print("App awake - refreshing...")
                  driver.refresh()
                  
          except Exception as e:
              print(f"Error: {str(e)}")
          finally:
              driver.quit()
          EOF
