name: Keep Streamlit App Alive

on:
  schedule:
    - cron: '*/10 * * * *'  # Every 10 minutes
  workflow_dispatch:

jobs:
  wake-up:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Playwright
        run: |
          python -m pip install playwright
          playwright install chromium

      - name: Run wake-up script
        run: |
          python - <<EOF
          from playwright.sync_api import sync_playwright

          with sync_playwright() as p:
              browser = p.chromium.launch(headless=True)
              page = browser.new_page()
              
              try:
                  # Navigate to app
                  page.goto("https://makans.streamlit.app/", wait_until="networkidle")
                  
                  # Debug: Save screenshot for inspection
                  page.screenshot(path="debug.png")
                  
                  # Check for sleep page using XPath
                  sleep_element = page.query_selector('//button[contains(., "Yes, get this app back up?")]')
                  
                  if sleep_element:
                      print("App is asleep. Clicking button...")
                      sleep_element.click()
                      
                      # Wait for app to restart (longer timeout)
                      page.wait_for_selector('//div[@class="stApp"]', timeout=60000)
                      print("App restarted!")
                  else:
                      print("App is awake. Refreshing...")
                      page.reload()
                      
              except Exception as e:
                  print(f"Error: {str(e)}")
              finally:
                  browser.close()
          EOF

      - name: Upload debug screenshot
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: playwright-debug
          path: debug.png
